<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LTV Loss Calculator – Embed (Green + UTM Persist)</title>
  <style>
    /* ========= Brand tokens (approx original Tailwind theme) ========= */
    :root{
      --brand-bg:#0a0b0f;            /* page background (near-black) */
      --brand-card:#12131a;          /* card background */
      --brand-text:#f3f4f6;          /* primary text */
      --brand-muted:#98a2b3;         /* muted text */
      --brand-primary:#ff1f3d;       /* Convertico red for CTA / highlights */
      --brand-primary-600:#e01832;   /* darker red hover */
      --brand-accent:#22c55e;        /* neon/cash green (replacing yellow) */
      --brand-success:#22c55e;       /* same neon green for "win" values */
      --border:#22242f;              /* subtle borders */
    }

    html,body{height:100%}
    body{
      margin:0;
      background:var(--brand-bg);
      color:var(--brand-text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, Apple Color Emoji, Segoe UI Emoji;
    }

    /* Utility-ish classes */
    .maxw{max-width:1200px;margin:0 auto;padding:0 1.25rem}
    .section{padding:3.5rem 0}
    .text-center{text-align:center}
    .text-muted{color:var(--brand-muted)}
    .text-primary{color:var(--brand-primary)}
    .bg-card{background:var(--brand-card)}
    .rounded-xl{border-radius:1rem}
    .rounded-2xl{border-radius:1.25rem}
    .border{border:1px solid var(--border)}
    .shadow-2xl{box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .grid{display:grid}
    .gap-12{gap:3rem}
    .gap-8{gap:2rem}
    .gap-4{gap:1rem}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;
      padding:.9rem 1.25rem;border-radius:1rem;border:none;
      background:var(--brand-primary);color:white;font-weight:600;cursor:pointer;
      transition:transform .15s ease, background .2s ease, box-shadow .2s ease;
    }
    .btn:hover{background:var(--brand-primary-600);transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.98)}
    .btn-block{width:100%}

    /* Headings */
    h2{font-size:clamp(1.75rem, 2vw + 1rem, 2.25rem);margin:.25rem 0 1rem}
    h3{font-size:1.25rem;margin:0 0 .75rem}

    /* Calculator layout */
    .calc-wrap{
      display:grid;gap:3rem;
      grid-template-columns:1fr;
    }
    @media(min-width:1024px){
      .calc-wrap{grid-template-columns:1.15fr .85fr}
    }

    /* Control group */
    .control{margin-bottom:1.25rem}
    .label{display:block;font-size:.9rem;font-weight:600;margin-bottom:.45rem}
    .row{display:flex;align-items:center;gap:1rem}
    .num{
      width:6.5rem;background:var(--brand-bg);border:1px solid var(--border);
      color:var(--brand-text);border-radius:.6rem;padding:.55rem .65rem;
      font-weight:600;
    }
    .num::-webkit-outer-spin-button,.num::-webkit-inner-spin-button{appearance:none;margin:0}

    /* Range styling */
    .range{appearance:none;width:100%;height:0.425rem;background:#1b1d27;border-radius:999px;outline:none}
    .range::-webkit-slider-thumb{
      appearance:none;width:18px;height:18px;border-radius:50%;
      background:radial-gradient(35% 35% at 50% 50%, #ffffff 0%, var(--brand-accent) 60%);
      border:2px solid #0b0d12;
      box-shadow:0 0 0 6px rgba(34,255,138,.28), 0 0 22px rgba(34,255,138,.25);
      cursor:pointer;
      transition:box-shadow .2s ease, transform .1s ease;
    }
    .range:active::-webkit-slider-thumb{transform:scale(1.03)}
    .range::-moz-range-thumb{
      width:18px;height:18px;border-radius:50%;
      background:var(--brand-accent);
      border:2px solid #0b0d12;
      box-shadow:0 0 0 6px rgba(34,255,138,.28), 0 0 22px rgba(34,255,138,.25);
      cursor:pointer;
    }

    /* Result card */
    .result-card{padding:2rem;background:var(--brand-card);border:1px solid var(--border);border-radius:1.25rem}
    .big-number{font-size:clamp(2.25rem, 3vw + 1rem, 3.25rem);font-weight:800;color:var(--brand-primary);letter-spacing:.3px}
    .muted{color:var(--brand-muted);margin-top:.25rem}

    /* Impact rows */
    .impact{display:grid;gap:.75rem}
    .impact-row{
      position:relative;border:1px solid var(--border);border-radius:1rem;padding:1rem 1.25rem;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0) 60%);
      overflow:hidden;
    }
    .impact-row .badge{
      display:inline-flex;align-items:center;gap:.45rem;
      background:var(--brand-success);color:#0a0b0f;padding:.25rem .6rem;border-radius:999px;
      font-size:.85rem;font-weight:800; letter-spacing:.15px; text-shadow:0 0 8px rgba(34,255,138,.35);
      box-shadow:0 0 0 3px rgba(34,255,138,.28);
    }
    .impact-row .value{
      font-size:clamp(1.5rem, 2vw + .75rem, 2rem);font-weight:900;float:right;
      color:var(--brand-success); text-shadow:0 0 14px rgba(34,255,138,.25);
    }

    /* Container wrapper for the whole embed for easy theming */
    .embed-shell{padding:2rem 0}

    /* Subheading */
    .sub{max-width:42rem;margin:.25rem auto 0;color:var(--brand-muted)}

    /* Accessibility focus */
    :where(button,input[type=range],input[type=number]){
      outline:none
    }
    :where(button,input[type=range],input[type=number]):focus-visible{
      box-shadow:0 0 0 2px rgba(255,255,255,.07), 0 0 0 4px rgba(34,255,138,.28);
    }

    /* Optional count-up animation */
    .count-anim{transition:opacity .12s ease}
  </style>
</head>
<body>
  <main class="embed-shell">
    <section class="section" id="calculator">
      <div class="maxw">
        <div class="text-center" style="margin-bottom:2.25rem">
          <div class="icon" aria-hidden="true" style="margin-bottom:.6rem">
            <!-- Calculator icon -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:3rem;height:3rem;color:var(--brand-primary)">
              <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
              <line x1="9" y1="8" x2="15" y2="8"></line>
              <line x1="9" y1="12" x2="9" y2="12"></line>
              <line x1="12" y1="12" x2="12" y2="12"></line>
              <line x1="15" y1="12" x2="15" y2="12"></line>
              <line x1="9" y1="16" x2="9" y2="16"></line>
              <line x1="12" y1="16" x2="12" y2="16"></line>
              <line x1="15" y1="16" x2="15" y2="16"></line>
            </svg>
          </div>
          <h2>LTV Loss Calculator</h2>
          <p class="sub">See exactly how much lifetime value you’re losing with poor conversion rates</p>
        </div>

        <div class="calc-wrap">
          <!-- Controls -->
          <div>
            <div class="control">
              <label class="label">Monthly Site Sessions</label>
              <div class="row">
                <input id="sessionsRange" class="range" type="range" min="10000" max="200000" step="5000" value="50000" />
                <input id="sessionsNum" class="num" type="number" inputmode="numeric" value="50000" />
              </div>
            </div>

            <div class="control">
              <label class="label">Current Sign-up Rate (%)</label>
              <div class="row">
                <input id="currentRange" class="range" type="range" min="0.5" max="10" step="0.1" value="2.0" />
                <input id="currentNum" class="num" type="number" step="0.1" value="2.0" />
              </div>
            </div>

            <div class="control">
              <label class="label">Target Sign-up Rate (%)</label>
              <div class="row">
                <input id="targetRange" class="range" type="range" min="1" max="15" step="0.1" value="3.5" />
                <input id="targetNum" class="num" type="number" step="0.1" value="3.5" />
              </div>
            </div>

            <div class="control">
              <label class="label">First Deposit Rate (%)</label>
              <div class="row">
                <input id="ftdRange" class="range" type="range" min="10" max="80" step="1" value="35" />
                <input id="ftdNum" class="num" type="number" step="1" value="35" />
              </div>
            </div>

            <div class="control">
              <label class="label">Average LTV per Funded Trader (USD)</label>
              <div class="row">
                <input id="ltvRange" class="range" type="range" min="200" max="2000" step="50" value="600" />
                <input id="ltvNum" class="num" type="number" step="50" value="600" />
              </div>
            </div>

            <div class="control">
              <label class="label">Time Horizon (Months)</label>
              <div class="row">
                <input id="monthsRange" class="range" type="range" min="3" max="24" step="1" value="12" />
                <input id="monthsNum" class="num" type="number" step="1" value="12" />
              </div>
            </div>
          </div>

          <!-- Results -->
          <div class="result-card">
            <h3 class="text-center" style="margin-top:0">Lost LTV Opportunity</h3>
            <div class="text-center" style="margin:1.25rem 0 2rem">
              <div id="lostLtv" class="big-number count-anim">$0</div>
              <div id="monthsLabel" class="muted">Over 12 months</div>
            </div>

            <div class="impact" style="margin-bottom:1.25rem">
              <!-- +1pp -->
              <div class="impact-row">
                <span class="badge">+1pp
                  <span class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:1rem;height:1rem">
                      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                      <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                  </span>
                </span>
                <span id="pp1" class="value">$0</span>
              </div>
              <!-- +2pp -->
              <div class="impact-row">
                <span class="badge">+2pp
                  <span class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:1rem;height:1rem">
                      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                      <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                  </span>
                </span>
                <span id="pp2" class="value">$0</span>
              </div>
              <!-- +3pp -->
              <div class="impact-row">
                <span class="badge">+3pp
                  <span class="icon" aria-hidden="true">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" style="width:1rem;height:1rem">
                      <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                      <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                  </span>
                </span>
                <span id="pp3" class="value">$0</span>
              </div>
            </div>

            <button id="cta" class="btn btn-block">Apply Now to Unlock This Upside</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    /* ===== Robust UTM persistence (90-day TTL) ===== */
    const UTM_KEYS = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term"];
    const UTM_STORAGE_KEY = "convertico_utms";
    const UTM_TTL_MS = 90 * 24 * 60 * 60 * 1000;

    function parseUTMs(qs){
      const p = new URLSearchParams(qs||"");
      const o = {}; UTM_KEYS.forEach(k => o[k] = p.get(k) || "");
      return o;
    }
    function hasAnyUTM(obj){ return UTM_KEYS.some(k => obj[k] && obj[k].trim() !== ""); }
    function saveUTMs(u){
      try{ localStorage.setItem(UTM_STORAGE_KEY, JSON.stringify({ ...u, _ts: Date.now() })); }catch(e){}
    }
    function loadUTMs(){
      try{
        const raw = localStorage.getItem(UTM_STORAGE_KEY);
        if(!raw) return {};
        const data = JSON.parse(raw);
        if(!data || !data._ts) return {};
        const age = Date.now() - data._ts;
        if(age > UTM_TTL_MS){ localStorage.removeItem(UTM_STORAGE_KEY); return {}; }
        const out = {}; UTM_KEYS.forEach(k => out[k] = data[k] || "");
        return out;
      }catch(e){ return {}; }
    }
    function mergeUTMs(primary, fallback){
      const out = {}; UTM_KEYS.forEach(k => out[k] = primary[k] || fallback[k] || ""); return out;
    }

    // On load: capture current UTMs (if any), else use stored.
    const currentUTMs = parseUTMs(window.location.search);
    const storedUTMs  = loadUTMs();
    const activeUTMs  = mergeUTMs(currentUTMs, storedUTMs);
    if(hasAnyUTM(currentUTMs)) saveUTMs(activeUTMs);

    function appendUTMs(url){
      const urlObj = new URL(url);
      UTM_KEYS.forEach(k => { if(activeUTMs[k]) urlObj.searchParams.set(k, activeUTMs[k]); });
      return urlObj.toString();
    }

    // GA4 event tracking passthrough (if gtag exists in iframe)
    function trackEvent(eventName, parameters = {}) {
      if (typeof window !== "undefined" && window.gtag) {
        window.gtag("event", eventName, parameters);
      }
    }

    /* ===== Calculator state & bindings (parity with original logic) ===== */
    const els = {
      sessionsRange: document.getElementById('sessionsRange'),
      sessionsNum:   document.getElementById('sessionsNum'),
      currentRange:  document.getElementById('currentRange'),
      currentNum:    document.getElementById('currentNum'),
      targetRange:   document.getElementById('targetRange'),
      targetNum:     document.getElementById('targetNum'),
      ftdRange:      document.getElementById('ftdRange'),
      ftdNum:        document.getElementById('ftdNum'),
      ltvRange:      document.getElementById('ltvRange'),
      ltvNum:        document.getElementById('ltvNum'),
      monthsRange:   document.getElementById('monthsRange'),
      monthsNum:     document.getElementById('monthsNum'),
      lostLtv:       document.getElementById('lostLtv'),
      monthsLabel:   document.getElementById('monthsLabel'),
      pp1:           document.getElementById('pp1'),
      pp2:           document.getElementById('pp2'),
      pp3:           document.getElementById('pp3'),
      cta:           document.getElementById('cta'),
    };

    const state = {
      sessions: 50000,
      currentRate: 2.0,
      targetRate: 3.5,
      ftdRate: 35,
      ltv: 600,
      months: 12,
      lastLost: 0
    };

    // Two-way binding helpers
    function bindPair(rangeEl, numEl, key, parseFn){
      const commit = (value) => {
        state[key] = value;
        rangeEl.value = value;
        numEl.value = value;
        trackEvent('calculator_change', { field: key, value });
        update();
      };
      rangeEl.addEventListener('input', e => commit(parseFn(e.target.value)));
      numEl.addEventListener('input',  e => commit(parseFn(e.target.value)));
    }

    // Numeric parsers
    const toInt = (v)=> Math.max(0, parseInt(v || 0, 10) || 0);
    const toFloat = (v)=> Math.max(0, parseFloat(v || 0) || 0);

    // Animate number changes
    function animateNumber(el, from, to, duration=400){
      if(from === to){ el.textContent = formatMoney(to); return; }
      const start = performance.now();
      function step(now){
        const t = Math.min(1, (now - start) / duration);
        const eased = t<.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2, 3)/2; // easeInOutCubic
        const val = Math.round(from + (to - from) * eased);
        el.textContent = formatMoney(val);
        if(t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    function formatMoney(n){
      return '$' + (n||0).toLocaleString();
    }

    function computeLost(){
      const { sessions, currentRate, targetRate, ftdRate, ltv, months } = state;
      const lost = sessions * ((targetRate - currentRate)/100) * (ftdRate/100) * ltv * (months/12);
      return Math.max(0, Math.round(lost));
    }

    function computeDelta(pp){
      const { sessions, ftdRate, ltv, months } = state;
      const delta = sessions * ((pp)/100) * (ftdRate/100) * ltv * (months/12);
      return Math.round(delta);
    }

    function update(){
      const lost = computeLost();
      animateNumber(els.lostLtv, state.lastLost, lost, 450);
      state.lastLost = lost;
      els.monthsLabel.textContent = 'Over ' + state.months + ' months';

      els.pp1.textContent = formatMoney(computeDelta(1));
      els.pp2.textContent = formatMoney(computeDelta(2));
      els.pp3.textContent = formatMoney(computeDelta(3));

      // Optional: auto-resize for the parent page via postMessage
      const h = document.documentElement.scrollHeight;
      try{ parent.postMessage({ type:'ltv_calc_height', height:h }, '*'); }catch(e){}
    }

    // Wire up bindings
    bindPair(els.sessionsRange, els.sessionsNum, 'sessions', toInt);
    bindPair(els.currentRange,  els.currentNum,  'currentRate', toFloat);
    bindPair(els.targetRange,   els.targetNum,   'targetRate',  toFloat);
    bindPair(els.ftdRange,      els.ftdNum,      'ftdRate',     toInt);
    bindPair(els.ltvRange,      els.ltvNum,      'ltv',         toInt);
    bindPair(els.monthsRange,   els.monthsNum,   'months',      toInt);

    // CTA
    els.cta.addEventListener('click', function(){
      const url = appendUTMs('https://growth.convertico.co.za');
      trackEvent('calculator_submit', { lostLTV: state.lastLost });
      window.open(url, '_blank', 'noopener');
    });

    // Initial paint
    update();
  </script>
</body>
</html>
